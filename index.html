<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>دمو بازی — قطع میوه (Roznamcha)</title>
  <style>
    :root{
      --bg:#0b1320; --panel:#ffffff; --accent:#6c1aa8; --accent-2:#10b981; --muted:#8b95a1;
      --cta:#0ea5a3;
    }
    html,body{height:100%;margin:0;font-family:Vazirmatn,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#071226 0%, #071a2b 100%);display:flex;align-items:center;justify-content:center;padding:14px}
    .container{width:100%;max-width:900px;border-radius:14px;background:linear-gradient(180deg,#ffffff,#f8fafc);overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,.6)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #eef2f7}
    header h1{margin:0;font-size:1.1rem;color:var(--bg);font-weight:800}
    header .score{font-weight:800;color:var(--muted)}

    .stage{position:relative;background:linear-gradient(180deg,#eaf3ff,#ffffff);height:560px;display:flex;align-items:center;justify-content:center}
    canvas{width:100%;height:100%;display:block}

    .hud{display:flex;gap:12px;align-items:center;padding:12px 18px;border-top:1px solid #eef2f7;background:linear-gradient(180deg,#ffffff,#f8fafc)}
    .hud .info{flex:1;color:#24303a;font-weight:700}
    .hud .timer{font-weight:900;color:var(--accent)}
  

    /* floating download CTA */
    .cta {
  position: absolute;
  left: 16px;
  bottom: 16px;
  z-index: 60;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: #fff;
  padding: 16px 24px;
  border-radius: 18px;
  font-weight: 900;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 8px 30px rgba(108, 26, 168, 0.4);
  animation: float 3s ease-in-out infinite;
  transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  overflow: hidden;
  min-width: 220px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

.cta:hover {
  transform: translateY(-4px) scale(1.03);
  box-shadow: 0 12px 40px rgba(108, 26, 168, 0.6);
  border-color: rgba(255,255,255,0.3);
}

.cta-icon {
  font-size: 24px;
  transition: transform 0.3s ease;
}

.cta:hover .cta-icon {
  transform: scale(1.2) rotate(15deg);
}

.cta-text-container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 2px;
}

.cta-title {
  font-size: 15px;
  font-weight: 900;
  letter-spacing: -0.5px;
  line-height: 1.3;
}

.cta-subtitle {
  font-size: 12px;
  font-weight: 600;
  opacity: 0.9;
  transition: opacity 0.3s ease;
}

.cta:hover .cta-subtitle {
  opacity: 1;
}

/* Shimmer on hover */
.cta-shimmer {
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transform: skewX(-25deg);
  transition: left 0.8s ease;
}

.cta:hover .cta-shimmer {
  left: 100%;
}

/* Responsive */
@media (max-width: 640px) {
  .cta {
    padding: 14px 18px;
    min-width: 180px;
    left: 12px;
    bottom: 12px;
  }
  .cta-title { font-size: 14px; }
  .cta-subtitle { font-size: 11px; }
}

    /* overlay end screen */
    .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(3,7,18,0.45),rgba(3,7,18,0.65));backdrop-filter:blur(2px);z-index:80;display:none}
    .overlay.show{display:flex}
    .card{background:#fff;padding:22px;border-radius:12px;max-width:420px;text-align:center}
    .card h2{margin:0 0 10px 0;color:var(--bg)}
    .card p{color:var(--muted);margin:0 0 18px 0}
    .download-btn{display:inline-block;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:12px 18px;border-radius:10px;text-decoration:none;font-weight:800}

    /* Roznamcha watermark */
    .watermark {
      position: absolute;
      right: 18px;
      top: 18px;
      opacity: .08;
      font-size: 42px;
      color: #000;
      pointer-events: none;
      font-weight: 900;
      animation: pulse 4s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.08; transform: scale(1); }
      50% { opacity: 0.15; transform: scale(1.05); }
    }


    /* responsive */
    @media (max-width:640px){ .stage{height:70vh} .watermark{font-size:30px; animation-duration: 6s;} }
     /* Permanent BHMN Signature — Below Game Over Card */
    .bhmn-signature {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%) translateY(30px);
      opacity: 0;
      z-index: 85;
      pointer-events: none;
      transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .bhmn-signature.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .bhmn-signature strong {
      font-size: 24px;
      font-weight: 900;
      background: linear-gradient(90deg, #6c1aa8, #10b981);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: var(--accent);
      text-shadow: 0 0 8px rgba(108, 26, 168, 0.3);
    }

    .bhmn-signature.show strong {
      animation: bhmnPulse 3s ease-in-out infinite;
    }

    @keyframes bhmnPulse {
      0%, 100% { text-shadow: 0 0 8px rgba(108, 26, 168, 0.3); }
      50% { text-shadow: 0 0 16px rgba(16, 185, 129, 0.6); }
    }
  </style>
</head>
<body>
  <div class="container" role="application">
    <header>
      <h1>میوه ها ره قطع کو — همکار و دوست شما روزنامچه</h1>
      <div class="score">امتیاز: <span id="score">0</span></div>
    </header>

    <div class="stage">
      <canvas id="gameCanvas" width="900" height="560" style="touch-action: none;" aria-label="بازی قطع میوه"></canvas>

      <div class="watermark">روزنامچه دستیار مالی دوکان شما</div>

     <a class="cta" id="floatingCta"
   href="https://github.com/MLd10Sar/Esmat/releases/download/v1.0.0/app-release.apk"
   target="_blank"
   rel="noopener noreferrer"
   aria-label="دانلود برنامه روزنامچه برای مدیریت دکان">
  <div class="cta-icon">📲</div>
  <div class="cta-text-container">
    <div class="cta-title" id="ctaTitle">روزنامچه ره نصب کو</div>
    <div class="cta-subtitle" id="ctaSubtitle">دوکانت ره هوشمند کو!</div>
  </div>
  <div class="cta-shimmer"></div>
</a>

      <div class="overlay" id="overlay">
        <div class="card">
          <h2 id="overlayTitle">خسته نباشی!</h2>
          <p id="overlayText">کامیاب باشی دوست عزیز اگر از بازی خوشت آمد و خواستی همایت کنی، برنامه روزنامچه را نصب و امتحان کن روزنامچه مثل کتابچه رسیدات یا لیجر است که تمام دخل و خرج و قرض و طلب گدام خود را مدیریت میتانی و هر جنس ره که بیاری فقط یک دفعه راجسترش کو و روزنامچه برت تعقیب اش میکنه اوتومات و ها یادم نره که روزنامچه پیام هم برت روان میکنه هر روز اگه تب خوش باشه از فایده و نقص روزت میگه که چقده فایده کدی و چقدر ضرر کدی دیگه خدا یار و نگهدارت.</p>
          <a id="overlayDownload" class="download-btn" href="https://github.com/MLd10Sar/Esmat/releases/download/v1.0.0/app-release.apk" target="_blank">📥 دانلود روزنامچه</a>
        </div>
      </div>
    </div>

    <div class="hud">
      <div class="info">میوه‌های مخصوص روزنامچه را قطع کنید تا پیام ویژه ببینید.</div>
      <div class="timer">زمان: <span id="time">60</span>s</div>
    </div>
  </div>

  <script>
    // Fruit Cutter — Simple, mobile-friendly, Roznamcha-branded
    (function(){
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const scoreEl = document.getElementById('score');
      const timeEl = document.getElementById('time');
      const overlay = document.getElementById('overlay');
      const overlayTitle = document.getElementById('overlayTitle');
      const overlayText = document.getElementById('overlayText');

      // logical size independent from CSS size
      function fitCanvas(){
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.round(rect.width * devicePixelRatio);
        canvas.height = Math.round(rect.height * devicePixelRatio);
        ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      }
      fitCanvas();
      window.addEventListener('resize', fitCanvas);
      window.addEventListener('load', fitCanvas);
      let score = 0;
      let timeLeft = 60; // seconds
      let running = true;
      window.audioUnlocked = false; 

 // Auto-detect device type and handle audio unlock
const isCoarsePointer = window.matchMedia("(pointer: coarse)").matches;

if (isCoarsePointer) {
  // Mobile/touch device → show tap overlay
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

  const tapOverlay = document.createElement('div');
  tapOverlay.innerHTML = '👆 لمس کنید تا شروع شود<br><small>برای فعال‌سازی صدا</small>';
  Object.assign(tapOverlay.style, {
    position: 'absolute',
    top: 0,
    left: 0,
    width: '100%',
    height: '100%',
    background: 'rgba(0,0,0,0.8)',
    color: 'white',
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'center',
    fontSize: '18px',
    fontWeight: '800',
    zIndex: 9999,
    textAlign: 'center',
    direction: 'rtl',
    fontFamily: 'Vazirmatn, Arial',
    lineHeight: '1.4',
    cursor: 'pointer', // 👈 Shows hand cursor
    userSelect: 'none' // 👈 Prevents text selection
  });
  document.querySelector('.stage').appendChild(tapOverlay);

  function removeTapOverlay() {
    tapOverlay.remove();
    window.audioUnlocked = true;
    if ('vibrate' in navigator) {
      navigator.vibrate(50);
    }
    if (sounds.slice) {
      const sound = sounds.slice.cloneNode();
      sound.volume = 0.05;
      sound.play().catch(() => {});
    }
  }


  // Attach to overlay itself
  tapOverlay.addEventListener('touchstart', removeTapOverlay, { once: true });
  tapOverlay.addEventListener('click', removeTapOverlay, { once: true });
} else {
  // On Android/Desktop → auto-unlock or unlock on first interaction
  window.audioUnlocked = !isCoarsePointer; // Auto-unlock on desktop
  if (isCoarsePointer) {
    // On Android → unlock on first canvas interaction
    const unlockOnInteraction = () => {
      window.audioUnlocked = true;
      canvas.removeEventListener('touchstart', unlockOnInteraction);
      canvas.removeEventListener('click', unlockOnInteraction);
    };
    canvas.addEventListener('touchstart', unlockOnInteraction, { once: true });
    canvas.addEventListener('click', unlockOnInteraction, { once: true });
  }
}

      const sounds = {
  slice: new Audio('slice.mp3'),
  explosion: new Audio('explosion.mp3'),
  sour: new Audio('sour.mp3'),
  golden: new Audio('golden.mp3'),
  gameover: new Audio('gameover.mp3')
};

// Optional: Set volume
Object.values(sounds).forEach(sound => {
  sound.volume = 0.4; // Softer, not too loud
});
      function flashScreen(color, duration) {
  const flash = document.createElement('div');
  Object.assign(flash.style, {
    position: 'absolute',
    top: 0,
    left: 0,
    width: '100%',
    height: '100%',
    background: color,
    opacity: 0.3,
    pointerEvents: 'none',
    zIndex: 9999,
  });
  document.body.appendChild(flash);
  setTimeout(() => {
    flash.style.transition = 'opacity 0.2s';
    flash.style.opacity = '0';
    setTimeout(() => flash.remove(), 200);
  }, duration);
}

    function shakeScreen(intensity = 5, duration = 200) {
  const container = document.querySelector('.container');
  const originalTransform = container.style.transform || '';
  let start = null;
  function step(timestamp) {
    if (!start) start = timestamp;
    const progress = timestamp - start;
    if (progress < duration) {
      const x = (Math.random() - 0.5) * intensity;
      const y = (Math.random() - 0.5) * intensity;
      container.style.transform = `translate(${x}px, ${y}px)`;
      requestAnimationFrame(step);
    } else {
      container.style.transform = originalTransform;
    }
  }
  requestAnimationFrame(step);
}
      // pointer tracking for slicing
      let pointerPath = []; // last points
      const MAX_PATH = 6;

      // fruits
      const fruits = [];
      const gravity = 0.28;

      // spawn settings
      let spawnInterval = 800; // ms
      let lastSpawn = 0;

      // Roznamcha fruit appears about 1 in 12 spawns
      function randomFruit(x){
        const t = Math.random();
        if(t < 0.08) return {type:'bomb'}; // bombs cause -points
        if(t < 0.15) return {type:'roz'}; // roznamcha special
        const kinds = ['apple','orange','kiwi','banana','grape','melon', 'strawberry', 'pineapple', 'mango', 'cherry','lemon', 'golden'];
        return {type: kinds[Math.floor(Math.random()*kinds.length)]};
      }

  function spawn(now){
  lastSpawn = now;
  const startX = 40 + Math.random() * (canvas.width/devicePixelRatio - 80);
  let vy = 0.3 + Math.random() * 0.5; // 🐢 Start slower: 0.3 to 0.8
  const vx = (Math.random() - 0.5) * 1.2; // Slight horizontal drift
  const f = randomFruit(startX);
  
  let radius;
  if (f.type === 'bomb') {
    radius = 40;
  } else if (f.type === 'roz') {
    radius = 50;
  } else if (f.type === 'pineapple') {
    radius = 42;
  } else if (f.type === 'cherry') {
    radius = 28;
  } else if (f.type === 'banana') {
    radius = 38 + Math.random() * 4;
  } else if (f.type === 'golden') {
    radius = 38;
  } else if (f.type === 'lemon') {
    radius = 30;
  } else {
    radius = 34 + Math.random() * 8;
  }

  let gravity = 0.12; // 🐢 Reduced from 0.18 → much more playable
  if (f.type === 'roz') {
    vy *= 0.6;       // Even slower for special fruit
    gravity = 0.08;  // Very gentle float
  }

  fruits.push({
    x: startX,
    y: -radius,      // Spawn above top
    vx,
    vy,
    ax: 0,
    ay: gravity,
    r: radius,
    type: f.type,
    spawned: now,
    hit: false,
    shards: []
  });
}
      // drawing helpers
      function drawFruit(fr){
        ctx.save();
        ctx.translate(fr.x,fr.y);
        // shadow
        ctx.beginPath();
        ctx.ellipse(0, fr.r + 8, fr.r * 0.9, fr.r * 0.35, 0, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,0,0,0.12)';
        ctx.fill();

        // body
         if (fr.type === 'bomb') {
    ctx.beginPath();
    ctx.arc(0, 0, fr.r, 0, Math.PI * 2);
    ctx.fillStyle = '#111'; // Dark bomb
    ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 16px Vazirmatn,Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('بمب', 0, 0);
  } else if (fr.type === 'roz') {
    // Roznamcha branded fruit (purple-green gradient)
     const g = ctx.createLinearGradient(-fr.r, -fr.r, fr.r, fr.r);
    g.addColorStop(0, '#6c1aa8');
    g.addColorStop(1, '#10b981');
    ctx.beginPath();
    ctx.arc(0, 0, fr.r, 0, Math.PI * 2);
    ctx.fillStyle = g;
    ctx.fill();
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.font = 'bold 16px Vazirmatn,Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('روزنامچه', 0, 0);
  } else if (fr.type === 'banana') {
    // Banana as ellipse
     ctx.save();

    // Rotate slightly for natural curve
    ctx.rotate(-0.3); // slight tilt

    // Draw banana body with curve
    ctx.beginPath();
    ctx.moveTo(-fr.r * 1.2, 0);
    ctx.quadraticCurveTo(0, -fr.r * 0.8, fr.r * 1.2, 0); // top curve
    ctx.quadraticCurveTo(0, fr.r * 0.4, -fr.r * 1.2, 0);   // bottom curve
    ctx.fillStyle = '#facc15';
    ctx.fill();

    // Add subtle highlight
    ctx.beginPath();
    ctx.moveTo(-fr.r * 1.1, -2);
    ctx.quadraticCurveTo(0, -fr.r * 0.6, fr.r * 1.0, -2);
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Add stem (small brown cap at top)
    ctx.beginPath();
    ctx.ellipse(0, -fr.r * 0.7, fr.r * 0.2, fr.r * 0.15, 0, 0, Math.PI * 2);
    ctx.fillStyle = '#8B4513'; // SaddleBrown
    ctx.fill();

    // Label
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.font = '600 14px Vazirmatn,Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('کیله', 0, fr.r * 0.3);

    ctx.restore();
  } else {
    // Normal fruits with beautiful colors
    const colors = {
      apple: '#ef4444',
      orange: '#fb923c',
      kiwi: '#86efac',
      banana: '#facc15',
      grape: '#7c3aed',
      melon: '#34d399',
      strawberry: '#ec4899',   // 💖 Pink
      pineapple: '#fbbf24',   // 🟡 Golden yellow
      mango: '#f97316',       // 🟠 Bright orange
      cherry: '#be123c',       // ❤️ Deep red
      lemon: '#fde047',       // 🍋 Lemon yellow
      golden: '#fbbf24'       // 🌟 Golden (we’ll override with gradient)
    };
    const col = colors[fr.type] || '#f97316'; // fallback to orange


      // Normal circle fruits

    ctx.beginPath();
    ctx.arc(0, 0, fr.r, 0, Math.PI * 2);
    ctx.fillStyle = col; // ✅ THIS MUST BE SET BEFORE FILL
    ctx.fill();
    

    // Draw label
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.font = '600 15px Vazirmatn,Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    let label = 'میوه';
switch(fr.type) {
  case 'apple': label = 'سیب'; break;
  case 'orange': label = 'کینو'; break;
  case 'kiwi': label = 'کیوی'; break;
  case 'banana': label = 'کیله'; break;
  case 'grape': label = 'انگور'; break;
  case 'melon': label = 'خربوزه'; break;
  case 'strawberry': label = 'توت فرنگی'; break;
  case 'pineapple': label = 'آناناس'; break;
  case 'mango': label = 'ام'; break;
  case 'cherry': label = 'گیلاس'; break;
  case 'lemon': label = 'لیمو 🍋'; break;       // 🍋
  case 'golden': label = 'طلایی 🌟'; break;     // 🌟
}
    ctx.fillText(label, 0, 0);
  }

  ctx.restore();
}

      // particle shards when sliced
      function createShards(fr, cx, cy){
        const pieces = 8 + Math.floor(Math.random()*6);
        for(let i=0;i<pieces;i++){
          const ang = Math.random()*Math.PI*2;
          const spd = 2 + Math.random()*5;
          fr.shards.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,life:40 + Math.random()*30,col: (fr.type==='roz'?'#9b5cf6':'#fff')});
        }
      }

      // slicing detection: check segment intersect circle
      function segmentCircle(x1,y1,x2,y2,cx,cy,r){
        const vx = x2-x1, vy = y2-y1;
        const wx = cx - x1, wy = cy - y1;
        const proj = (vx*wx + vy*wy) / (vx*vx + vy*vy || 1);
        const closestX = x1 + Math.max(0, Math.min(1, proj)) * vx;
        const closestY = y1 + Math.max(0, Math.min(1, proj)) * vy;
        const dx = closestX - cx, dy = closestY - cy;
        return (dx*dx + dy*dy) <= r*r;
      }

      // pointer events
      let pointerDown = false;
      function addPointerPoint(x,y){
        pointerPath.push({x,y,t:Date.now()});
        if(pointerPath.length>MAX_PATH) pointerPath.shift();
      }

      canvas.addEventListener('pointerdown', e=>{ pointerDown=true; addPointerPoint(e.offsetX, e.offsetY); e.preventDefault(); });
      canvas.addEventListener('pointermove', e=>{ if(!pointerDown) return; addPointerPoint(e.offsetX, e.offsetY); e.preventDefault(); });
      canvas.addEventListener('pointerup', e=>{ pointerDown=false; pointerPath.length=0; e.preventDefault(); });
      canvas.addEventListener('pointercancel', ()=>{ pointerDown=false; pointerPath.length=0; });

      // touch fallback: prevent scroll
      canvas.addEventListener('touchstart', e=>{ e.preventDefault(); }, {passive:false});

      // main loop
      let lastTime = performance.now();
      function loop(now){
        const dt = now - lastTime; lastTime = now;
        if(!running){ draw(); requestAnimationFrame(loop); return; }

        // spawn
        if(now - lastSpawn > spawnInterval){ spawn(now); }

        // update fruits
        for(let i=fruits.length-1;i>=0;i--){
          const f = fruits[i];
          if(f.hit){
            // update shards
            for(let s of f.shards){ s.vy += 0.14; s.x += s.vx; s.y += s.vy; s.life -= 1; }
            if(f.shards.length && f.shards.every(s=>s.life<=0)) fruits.splice(i,1);
            continue;
          }

          f.vy += f.ay; f.x += f.vx; f.y += f.vy;

          // out of screen -> remove
          if(f.y - f.r > canvas.height/devicePixelRatio + 60){ fruits.splice(i,1); continue; }

          // check slice with pointer path
          if(pointerPath.length>1){
            for(let p=0;p<pointerPath.length-1;p++){
              const a = pointerPath[p], b = pointerPath[p+1];
              if(segmentCircle(a.x, a.y, b.x, b.y, f.x, f.y, f.r)){
                // sliced!
                f.hit = true;
                createShards(f, f.x, f.y);
                // scoring
              if(f.type==='bomb'){
  score = Math.max(0, score - 20);
  flashScreen('#ff4444', 200);
  if (window.audioUnlocked) sounds.explosion.cloneNode().play().catch(e=>console.log("Sound failed"));
} else if(f.type==='lemon'){
  score = Math.max(0, score - 5);
  flashScreen('#ffff00', 150);
  if (window.audioUnlocked) sounds.sour.cloneNode().play().catch(e=>console.log("Sound failed"));
} else if(f.type==='golden'){
  score += 50;
  flashScreen('#ffd700', 300);
  if (window.audioUnlocked) sounds.golden.cloneNode().play().catch(e=>console.log("Sound failed"));
} else if(f.type==='roz'){
  score += 100;
  flashRozMessage();
  if (window.audioUnlocked) sounds.slice.cloneNode().play().catch(e=>console.log("Sound failed"));
} else {
  score += 10;
  if (window.audioUnlocked) sounds.slice.cloneNode().play().catch(e=>console.log("Sound failed"));
}
                scoreEl.textContent = score;
                break;
              }
            }
          }
        }

        // update shards life for fruits that are hit
        for(const f of fruits){ if(f.hit){ f.shards = f.shards.filter(s=>s.life>0); }}

        // decrease timer
        // use dt to reduce time smoothly
        timeLeft -= dt/1000;
        if(timeLeft <= 0){ timeLeft = 0; running=false; showOverlay(); }
        timeEl.textContent = Math.ceil(timeLeft);

        draw();
        requestAnimationFrame(loop);
      }
  

      function draw(){
        // clear
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // background subtle
        ctx.fillStyle = 'rgba(250,252,255,0.35)'; ctx.fillRect(0,0,canvas.width/devicePixelRatio,canvas.height/devicePixelRatio);

        // draw fruits
        for(const f of fruits){ if(!f.hit) drawFruit(f); else {
          // draw shards
          for(const s of f.shards){ ctx.fillStyle = s.col; ctx.beginPath(); ctx.arc(s.x, s.y, 3,0,Math.PI*2); ctx.fill(); }
        }}

        // draw pointer path
        if(pointerPath.length>1){ ctx.strokeStyle='rgba(255,255,255,0.92)'; ctx.lineWidth=6; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(pointerPath[0].x, pointerPath[0].y);
          for(let i=1;i<pointerPath.length;i++) ctx.lineTo(pointerPath[i].x, pointerPath[i].y);
          ctx.stroke();
        }
      }

      // special roz message
      let rozMsgTimer = 0;
      function flashRozMessage(){ rozMsgTimer = 60; }

      // overlay
      function showOverlay(){ overlay.classList.add('show'); overlayTitle.textContent = 'آفرین!'; overlayText.textContent = `امتیاز شما ${score} — کامیاب باشی دوست عزیز اگر از بازی خوشت آمد و خواستی همایت کنی، برنامه روزنامچه را نصب و امتحان کن روزنامچه مثل کتابچه رسیدات یا لیجر است که تمام دخل و خرج و قرض و طلب و گدام خود را مدیریت میتانی هر جنس ره که ده دکان بیاری فقط یک دفعه راجستر میکنی در گدام و روزنامچه برایت تعقیب اش میکنه اوتومات و ها یادم نره که روزنامچه پیام هم برت روان میکنه هر روز اگه تب خوش باشه از فایده و نقص روزت میگه که چقده فایده کدی و چقدر ضرر کدی و ها میتانی لوگوی دکان ات ره هم در برنامه با نام و آدرس بانی که هر وقت خواستی ورق رسید یا پشت قرض بری بجای ورق عادی از لوگوی خودت مثل یک شرکت به طرف مقابل روان کنی یک سند رسمی و قوی پیش خود میداشته باشی به نام دکان ات که بسیار در آینده برت کار آمد میشه دیگه خدا یار و نگهدارت.`; sounds.gameover.play().catch(e=>console.log("Game over sound failed"));
            // ============= PERMANENT BHMN SIGNATURE =============
      // Remove any existing signature
      const existingSig = document.querySelector('.bhmn-signature');
      if (existingSig) existingSig.remove();

      // Extra safety: remove any div containing "BHMN"
      document.querySelectorAll('.stage > div').forEach(el => {
        if (el.innerHTML.includes('BHMN')) {
          el.remove();
        }
      });

      // Create new signature
      const bhmnSignature = document.createElement('div');
      bhmnSignature.className = 'bhmn-signature';
      bhmnSignature.innerHTML = '✨ ساخته شده توسط <strong>BHMN</strong>';
      document.querySelector('.stage').appendChild(bhmnSignature);

      setTimeout(() => {
        bhmnSignature.classList.add('show');
        if (sounds.slice) sounds.slice.cloneNode().play().catch(() => {});
      }, 1000);
      // ============= END BHMN SIGNATURE =============

  }

      // start
      requestAnimationFrame(loop);

      // spawn rhythm control
setInterval(()=>{ 
  if(spawnInterval > 500) spawnInterval = Math.max(500, spawnInterval - 10); // slower ramp-up
}, 5000);
      // small tutorial auto-touch for first run
      setTimeout(()=>{ // spawn a few fruits quickly so player sees
        for(let i=0;i<3;i++) spawn(performance.now() + i*120);
      },600);

      // optional: clicking overlay restarts
      overlay.addEventListener('click', ()=>{ overlay.classList.remove('show'); restart(); });

      function restart(){ score=0; timeLeft=60; running=true; fruits.length=0; pointerPath.length=0; scoreEl.textContent=score; spawnInterval=700; lastSpawn=0; }

      // Auto-rotate CTA messages every 5 seconds
const ctaMessages = [
  { title: "همیالی روزنامچه رو نصب کو رفیق", subtitle: "دوکانت ره هوشمند کو مثل یک محاسب!" },
  { title: "روزنامچه همیشه کنارت هست", subtitle: "هر صبح فایده و ضرر دوکانت رو برت میگه!" },
  { title: "لوگوی دوکانت ره بساز!", subtitle: "حرفه‌ای کار کو با روزنامچه 🎯" },
  { title: "دیگه فراموش نکو چیزی ره!", subtitle: "روزنامچه همکار و در خدمت ات ⏰" },
  { title: "مدیریت قرض و طلب با یک کلیک!", subtitle: "دیگه کسی پیسه ته نمیبره 😊" }
];

let ctaMsgIndex = 0;
const ctaTitleEl = document.getElementById('ctaTitle');
const ctaSubtitleEl = document.getElementById('ctaSubtitle');

function rotateCtaMessage() {
  ctaMsgIndex = (ctaMsgIndex + 1) % ctaMessages.length;
  const msg = ctaMessages[ctaMsgIndex];
  ctaTitleEl.style.opacity = 0;
  ctaSubtitleEl.style.opacity = 0;
  
  setTimeout(() => {
    ctaTitleEl.textContent = msg.title;
    ctaSubtitleEl.textContent = msg.subtitle;
    ctaTitleEl.style.opacity = 1;
    ctaSubtitleEl.style.opacity = 1;
  }, 300);
}

// Start rotating every 5 seconds
setInterval(rotateCtaMessage, 5000);

           function unlockAudio() {
        Object.values(sounds).forEach(sound => sound.play().catch(() => {}));
        if (bgMusic) bgMusic.play().catch(() => {});
        canvas.removeEventListener('touchstart', unlockAudio);
        canvas.removeEventListener('click', unlockAudio);
      }

      canvas.addEventListener('touchstart', unlockAudio, { once: true });
      canvas.addEventListener('click', unlockAudio, { once: true });
    })();
  </script>
</body>
</html>